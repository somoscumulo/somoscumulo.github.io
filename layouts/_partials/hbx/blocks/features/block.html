{{- /* Override robusto del bloque "features" SIN 'func'
     - Soporta contexto como dict {"page","block"} o como map directo
     - Lee campos con 'index' (map) para evitar nil dereference
     - Acepta image como ruta absoluta (/img/... /media/...) o filename (fallback a /img/<file>)
     - Renderiza description con RenderString para respetar párrafos
*/ -}}

{{- $ctx := . -}}
{{- $page := $.Page -}}
{{- $block := $ctx -}}
{{- $ctxType := printf "%T" $ctx -}}

{{- /* Si viene como dict {"page","block"} */ -}}
{{- if or (eq $ctxType "map[string]interface {}") (eq $ctxType "map[string]any") -}}
  {{- with index $ctx "page"  }}{{ $page  = . }}{{ end -}}
  {{- with index $ctx "block" }}{{ $block = . }}{{ end -}}
{{- end -}}

{{- /* Para seguridad: esperamos map[string]any */ -}}
{{- $blockType := printf "%T" $block -}}
{{- if and (ne $blockType "map[string]interface {}") (ne $blockType "map[string]any") -}}
  <div class="container my-4 p-4 border border-red-300 text-red-600 rounded">
    (features) Contexto inválido para el bloque.
  </div>
{{- else -}}

{{- $id      := index $block "id" -}}
{{- $content := index $block "content" -}}
{{- $design  := index $block "design"  -}}

{{- $title := "" -}}
{{- with $content -}}
  {{- with index . "title" -}}{{- $title = . -}}{{- end -}}
{{- end -}}

{{- $items := slice -}}
{{- with $content -}}
  {{- with index . "items" -}}{{- $items = . -}}{{- end -}}
{{- end -}}

{{- $cols := "3" -}}
{{- with $design -}}
  {{- with index . "columns" -}}{{- $cols = . -}}{{- end -}}
{{- end -}}

<section id="{{ with $id }}{{ . }}{{ end }}" class="section">
  <div class="container">

    {{- with $title -}}
      <h2 class="section-heading">{{ . | $page.RenderString }}</h2>
    {{- end -}}

    <div class="grid md:grid-cols-{{ $cols }} gap-8">
      {{- if not $items -}}
        <div class="text-sm opacity-70">(features) No hay items para mostrar.</div>
      {{- else -}}
        {{- range $items -}}
          {{- $name     := index . "name" -}}
          {{- $desc     := index . "description" -}}
          {{- $img      := index . "image" -}}
          {{- $imgAlt   := or (index . "image_alt") "" -}}
          {{- $imgStyle := or (index . "image_style") "max-height:64px;margin:0 auto 8px;display:block;" -}}

          <div class="text-center">
            {{- with $img -}}
              {{- $src := . -}}
              {{- if hasPrefix $src "/" -}}
                <img src="{{ $src }}" alt="{{ $imgAlt }}" style="{{ $imgStyle }}">
              {{- else -}}
                {{- /* Intentar assets primero (media/img), y si no, fallback a /img/<file> de static */ -}}
                {{- $asset := resources.Get (printf "media/%s" $src) -}}
                {{- if not $asset }}{{ $asset = resources.Get (printf "img/%s" $src) }}{{ end -}}
                {{- if $asset -}}
                  <img src="{{ $asset.RelPermalink }}" alt="{{ $imgAlt }}" style="{{ $imgStyle }}">
                {{- else -}}
                  <img src="{{ printf "/img/%s" $src }}" alt="{{ $imgAlt }}" style="{{ $imgStyle }}">
                {{- end -}}
              {{- end -}}
            {{- end -}}

            {{- with $name -}}
              <h3 class="text-lg font-semibold">{{ . | $page.RenderString }}</h3>
            {{- end -}}

            {{- with $desc -}}
              <div class="mt-2 prose mx-auto">{{ . | $page.RenderString }}</div>
            {{- end -}}
          </div>
        {{- end -}}
      {{- end -}}
    </div>

  </div>
</section>
{{- end -}}
