{{/* layouts/shortcodes/people_list.html

Uso:
  {{< people_list group="equipo" columns=4 gapx="6rem" gapy="2.5rem" >}}

Requisitos por autor (bundle):
  content/authors/<slug>/_index.md
  content/authors/<slug>/avatar.(jpg|png|webp)
  Front matter por autor:
    title: "Nombre Apellido"   # o name:
    name: "Nombre Apellido"
    role: "Rol / Especialidad"
    user_group: ["equipo"]     # o ["colaboran"], también acepta "group"/"groups"
*/}}

{{- $group   := .Get "group"   | default "" -}}
{{- $columns := .Get "columns" | default 4 -}}
{{- $gapx    := .Get "gapx"    | default "6rem" -}}
{{- $gapy    := .Get "gapy"    | default "2.5rem" -}}

{{/* Traer todas las páginas de la sección authors, sólo las "regulares" (no _index de la sección raíz) */}}
{{- $all := where site.RegularPages "Section" "authors" -}}

{{/* Filtrado por grupo (user_group | group | groups), aceptando string o lista */}}
{{- $want := lower $group -}}
{{- $filtered := slice -}}
{{- range $all -}}
  {{- $pg := . -}}
  {{- $val := cond (isset $pg.Params "user_group") $pg.Params.user_group (cond (isset $pg.Params "group") $pg.Params.group (cond (isset $pg.Params "groups") $pg.Params.groups nil)) -}}
  {{- $hit := false -}}
  {{- if $want | and $val -}}
    {{- $t := printf "%T" $val -}}
    {{- if eq $t "string" -}}
      {{- if eq (lower $val) $want }}{{ $hit = true }}{{ end -}}
    {{- else -}}
      {{- $lowered := apply (slice) "printf" "." -}}
      {{- /* normalizamos a lista de strings en minúscula */ -}}
      {{- $list := slice -}}
      {{- range $val -}}
        {{- $list = $list | append (lower (printf "%v" .)) -}}
      {{- end -}}
      {{- if in $list $want }}{{ $hit = true }}{{ end -}}
    {{- end -}}
  {{- else if not $want -}}
    {{- /* si no se pidió grupo, incluir todos */ -}}
    {{- $hit = true -}}
  {{- end -}}
  {{- if $hit }}{{ $filtered = $filtered | append $pg }}{{ end -}}
{{- end -}}

{{- /* Orden: primero por weight (si hay), luego por Title */ -}}
{{- $filtered = sort (sort $filtered "Params.weight" "asc") "Title" "asc" -}}

{{/* CSS inline una sola vez por página */}}
{{- if not (.Page.Scratch.Get "people_list_css_v2") -}}
<style>
  .people-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr)); /* 2 en mobile */
    gap: {{ $gapy }} {{ $gapx }};
    justify-items:center;
    align-items:start;
  }
  @media (min-width: 900px){
    .people-grid{ grid-template-columns:repeat(var(--cols,4),minmax(0,1fr)); }
  }
  .people-item{ text-align:center; }
  .people-avatar{
    width: 12rem; height: 12rem;
    border-radius:9999px; overflow:hidden;
    box-shadow:0 2px 10px rgba(0,0,0,.08);
    margin:0 auto;
    display:flex; align-items:center; justify-content:center;
  }
  .people-avatar img{
    width:100%; height:100%;
    object-fit:cover; object-position:center;
    display:block;
  }
  .people-name{ margin-top:.45rem; font-weight:700; line-height:1.2; }
  .people-role{ margin-top:.15rem; font-size:.95rem; opacity:.8; }
  .people-link{ text-decoration:none !important; }
</style>
{{- .Page.Scratch.Set "people_list_css_v2" true -}}
{{- end -}}

<div class="people-grid" style="--cols: {{ $columns }};">
  {{- if gt (len $filtered) 0 -}}
    {{- range $filtered -}}
      {{- $title := .Params.name | default .Title -}}
      {{- $role  := .Params.role -}}
      {{- /* Avatar: primero Page Resource, luego fallback en /assets/authors/... */ -}}
      {{- $avatar := .Resources.GetMatch "avatar*" -}}
      {{- if not $avatar -}}
        {{- $slug := (path.Base (.File.Dir | strings.TrimSuffix "/")) -}}
        {{- $try := slice "jpg" "png" "webp" "jpeg" -}}
        {{- range $try -}}
          {{- if not $avatar -}}
            {{- $cand := resources.Get (printf "authors/%s/avatar.%s" $slug .) -}}
            {{- if $cand }}{{ $avatar = $cand }}{{ end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      <div class="people-item">
        <a href="{{ .RelPermalink }}" class="people-link" aria-label="Ir al perfil de {{ $title }}">
          <div class="people-avatar">
            {{- if $avatar -}}
              <img src="{{ $avatar.RelPermalink }}" alt="{{ $title }}">
            {{- else -}}
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='480' height='480'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='24'%3E{{ $title }}%3C/text%3E%3C/svg%3E" alt="{{ $title }}">
            {{- end -}}
          </div>
          <div class="people-name">{{ $title }}</div>
          {{- with $role -}}<div class="people-role">{{ . }}</div>{{- end -}}
        </a>
      </div>
    {{- end -}}
  {{- else -}}
    <div style="text-align:center;opacity:.6;">No hay perfiles en el grupo “{{ $group }}”.</div>
  {{- end -}}
</div>
